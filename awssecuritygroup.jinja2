{% if security_groups is defined and security_groups|length > 0 %}
{% for sg in security_groups %}
resource "aws_security_group" "{{ resource_name | replace('-', '_') }}_{{ sg.name }}" {
  name        = "{{ sg.name }}"
  description = "{{ sg.description }}"
  vpc_id      = aws_vpc.{{ resource_reference }}.id

  tags = {
    Name = "{{ resource_name }}-{{ sg.name }}"
  }
}

{% if sg.ingress is defined %}
{% for rule in sg.ingress %}
resource "aws_security_group_rule" "{{ resource_name }}_{{ sg.name }}_ingress_{{ loop.index }}" {
  type              = "ingress"
  from_port         = {{ rule.from_port }}
  to_port           = {{ rule.to_port }}
  protocol          = "{{ rule.protocol }}"
  cidr_blocks       = ["{{ rule.cidr }}"]
  security_group_id = aws_security_group.{{ resource_name | replace('-', '_') }}_{{ sg.name }}.id
}
{% endfor %}
{% endif %}

{% if sg.egress is defined %}
{% for rule in sg.egress %}
resource "aws_security_group_rule" "{{ resource_name }}_{{ sg.name }}_egress_{{ loop.index }}" {
  type              = "egress"
  from_port         = {{ rule.from_port }}
  to_port           = {{ rule.to_port }}
  protocol          = "{{ rule.protocol }}"
  cidr_blocks       = ["{{ rule.cidr }}"]
  security_group_id = aws_security_group.{{ resource_name | replace('-', '_')}}_{{ sg.name }}.id
}
{% endfor %}
{% endif %}

{% endfor %}
{% endif %}